git init---

# STM32 多传感器集成开发项目日志 (2026-01-03)

## 1. 硬件清单与接线方式

项目基于 STM32F103C8T6 核心板，通过 I2C 和 UART 协议集成了姿态、定位与环境感应模块。

### 1.1 硬件列表

- **MCU**: STM32F103C8T6 (Blue Pill)
- **姿态传感器**: MPU6050 (六轴 IMU)
- **定位模块**: GPS (支持 GNRMC 协议)
- **环境传感器**: AHT20 (温湿度) + BMP280 (气压/高度) 组合模块

### 1.2 接口映射表

| 外设名称            | 接口类型    | 引脚分配             | 说明                        |
| ------------------- | ----------- | -------------------- | --------------------------- |
| **I2C1 总线** | 总线 (共享) | PB6 (SCL), PB7 (SDA) | 挂载 MPU6050, AHT20, BMP280 |
| **USART1**    | 异步串口    | PA9 (TX), PA10 (RX)  | 用于 `printf` 重定向调试  |
| **USART2**    | 异步串口    | PA2 (TX), PA3 (RX)   | 连接 GPS 模块，开启中断接收 |

---

## 2. STM32CubeMX 配置详细步骤

1. **时钟配置**: 外部高速晶振 (HSE)，通过 PLL 倍频至 **72MHz**。
2. **I2C1 配置**:
   - 模式: **I2C Standard Mode**
   - 速度: **100KHz**
3. **USART1 配置**:
   - Baud Rate: **115200**
   - 目的: 调试信息输出
4. **USART2 配置**:
   - Baud Rate: **9600** (GPS 默认)
   - **NVIC 设置**: 勾选 `USART2 global interrupt` 开启串口中断
5. **GPIO 配置**: 配置 `PC13` 为输出，用于 LED 状态指示

---

## 3. 各传感器工作原理与数学公式

### 3.1 MPU6050 姿态解算

- **加速度计**: 感知重力矢量
- **互补滤波**: 结合陀螺仪的动态响应和加速度计的静态稳定性，消除零点漂移

公式如下：

\[\theta = \alpha \cdot (\theta + \omega \cdot \Delta t) + (1 - \alpha) \cdot \arcsin\left(\frac{a_x}{g}\right)\]

其中，采样周期 \(\Delta t = 0.01s\) (100Hz)。

### 3.2 环境感应 (AHT20 & BMP280)

- **AHT20**: 利用电容式感湿元件测量湿度，半导体感温元件测量温度
- **BMP280**: 利用压阻式感测技术测量气压，并通过气压值推算高度

海拔公式如下：

\[h = 44330 \cdot \left(1 - \left(\frac{P}{P_0}\right)^{\frac{1}{5.255}}\right)\]

其中，\(P_0 = 101325Pa\)。

---

## 4. 驱动代码配置思路及过程

### 4.1 模块化驱动结构

项目采用高内聚、低耦合的设计：

- **`mpu6050.c`**: 包含寄存器初始化（唤醒、量程配置）及互补滤波算法
- **`gps.c`**: 利用 `HAL_UART_RxCpltCallback` 回调函数，实现非阻塞式 GPS 报文接收
- **`aht20.c` & `bmp280.c`**: 共享 `hi2c1` 句柄，通过不同的从机地址（0x70 和 0xEC）实现分时通讯

### 4.2 非阻塞式任务调度

在 `main.c` 的主循环中，根据数据特性分配不同的采样频率：

- **100Hz 任务**: MPU6050 姿态读取，保证动作捕捉的灵敏度
- **1Hz 任务**: 环境数据读取（AHT20/BMP280），因为温湿度变化较慢
- **事件驱动**: GPS 数据处理，仅在中断触发且报文完整时处理

---

## 5. 预期实验结果

### 5.1 姿态监测

- **现象**: 串口输出 `P: 0.x R: 0.x`
- **结果**: 板子平放时角度接近零，快速翻转时数据实时跟随且平滑

### 5.2 环境监测 (当前测试结果)

- **AHT20**: 成功输出正常温湿度数据（如 `Temp: 25.3°C, Hum: 60.2%`）
- **BMP280**: 成功初始化，但由于代码中有意跳过了气压采集逻辑，目前输出为 `Baro: 0 Pa` 和 `Alt: 44330.0 m`

---

## 6. 未来目标 (Roadmap)

- [ ] **完善 BMP280**: 补全气压原始值读取逻辑，并引入温度补偿算法
- [ ] **跌落检测算法**: 基于 \(|a| = \sqrt{a_x^2 + a_y^2 + a_z^2}\) 的模长变化，检测自由落体与撞击
- [X] **LoRa 无线扩展**: 启用 **USART3 (PB10/PB11)**，将数据包远程发送至网关
- [ ] **GPS 解析器**: 编写解析逻辑，将经纬度从字符串转换为浮点数变量

---

**今天的工作确认了 I2C 总线多设备通信的稳定性。下一步你打算从哪个传感器开始继续完善？**
